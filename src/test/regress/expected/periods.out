/* System periods are not implemented */
create table periodst (id integer, ds date, de date, period for system_time (ds, de));
ERROR:  PERIOD FOR SYSTEM_TIME is not supported
LINE 2: ...ate table periodst (id integer, ds date, de date, period for...
                                                             ^
/* Periods must specify actual columns */
create table periodst (id integer, ds date, de date, period for p (bogus, de));
ERROR:  column "bogus" of relation "periodst" does not exist
create table periodst (id integer, ds date, de date, period for p (ds, bogus));
ERROR:  column "bogus" of relation "periodst" does not exist
/* Data types must match exactly */
create table periodst (id integer, ds date, de timestamp, period for p (ds, de));
ERROR:  start and end columns of period must be of same type
create table periodst (id integer, ds text collate "C", de text collate "POSIX", period for p (ds, de));
ERROR:  start and end columns of period must have same collation
/* Periods must have a default BTree operator class */
create table periodst (id integer, ds xml, de xml, period for p (ds, de));
ERROR:  no range type for xml found for period p
HINT:  You can define a custom range type with CREATE TYPE
/* Period and column names are in the same namespace */
create table periodst (id integer, ds date, de date, period for ctid (ds, de));
ERROR:  period name "ctid" conflicts with a system column name
create table periodst (id integer, ds date, de date, period for id (ds, de));
ERROR:  period name "id" conflicts with a column name
/* Period name can't be given more than once */
create table periodst (id integer, ds date, de date, period for p (ds, de), period for p (ds, de));
ERROR:  period name "p" specified more than once
/* Period can't use the same colum for start and end*/
create table periodst (id integer, ds date, de date, period for p (ds, ds));
ERROR:  column "ds" can't be the start and end column for period "p"
/* Now make one that works */
create table periodst (id integer, ds date, de date, period for p (ds, de));
/* Its generated column looks good */
select attname, atttypid::regtype, attnotnull, attgenerated from pg_attribute
where attrelid = 'periodst'::regclass and attname = 'p';
 attname | atttypid  | attnotnull | attgenerated 
---------+-----------+------------+--------------
 p       | daterange | t          | s
(1 row)

select conname, contype from pg_constraint where conrelid = 'periodst'::regclass order by conname;
       conname       | contype 
---------------------+---------
 periodst_p_check    | c
 periodst_p_not_null | n
(2 rows)

/* It appears in the information_schema */
select * from information_schema.periods;
 table_catalog | table_schema | table_name | period_name | start_column_name | end_column_name 
---------------+--------------+------------+-------------+-------------------+-----------------
 regression    | public       | periodst   | p           | ds                | de
(1 row)

/* SELECT * excludes the PERIOD */
insert into periodst values (1, '2000-01-01', '2001-01-01');
select * from periodst;
 id |     ds     |     de     
----+------------+------------
  1 | 01-01-2000 | 01-01-2001
(1 row)

/* You can get it if you want */
select *, p from periodst;
 id |     ds     |     de     |            p            
----+------------+------------+-------------------------
  1 | 01-01-2000 | 01-01-2001 | [01-01-2000,01-01-2001)
(1 row)

/* You can comment on it */
comment on period periodst.p is 'test comment';
select obj_description((select oid from pg_period where perrelid = 'periodst'::regclass and pername = 'p'), 'pg_period');
 obj_description 
-----------------
 test comment
(1 row)

/* Two are okay */
create table periodst2 (id integer, ds date, de date, period for p1 (ds, de), period for p2 (ds, de));
drop table periodst2;
/* Skip creating GENERATED column: works */
create table periodst2 (id integer, ds date, de date, p daterange not null generated always as (daterange(ds, de)) stored, period for p (ds, de) with (colexists = true));
\d periodst2
             Table "public.periodst2"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           |          | 
 ds     | date    |           |          | 
 de     | date    |           |          | 
Periods:
    p (ds, de)
Check constraints:
    "periodst2_p_check" CHECK (ds < de)

drop table periodst2;
/* Skip creating GENERATED column: fails because the col isn't there */
create table periodst2 (id integer, ds date, de date, period for p (ds, de) with (colexists = true));
ERROR:  No column found with name p
/* Skip creating GENERATED column: fails because the option has an invalid value */
create table periodst2 (id integer, ds date, de date, period for p (ds, de) with (colexists = 'whatever'));
ERROR:  colexists requires a Boolean value
/* Skip creating GENERATED column: fails because the column is not NOT NULL */
create table periodst2 (id integer, ds date, de date, p daterange generated always as (daterange(ds, de)) stored, period for p (ds, de) with (colexists = true));
ERROR:  Period p uses a generated column that allows nulls
/* Skip creating GENERATED column: fails because the column is not GENERATED */
create table periodst2 (id integer, ds date, de date, p daterange not null, period for p (ds, de) with (colexists = true));
ERROR:  Period p uses a non-generated column
/* Skip creating GENERATED column: fails because the column is GENERATED but with the wrong expression */
-- TODO:
-- create table periodst2 (id integer, ds date, de date, p daterange not null generated always as (daterange(de, ds)) stored, period for p (ds, de) with (colexists = true));
/* Skip creating GENERATED column: fails because the column is the wrong type */
create table periodst2 (id integer, ds date, de date, p tsrange not null generated always as (tsrange(ds, de)) stored, period for p (ds, de) with (colexists = true));
ERROR:  Period p uses a generated column with the wrong type
/* Skip creating GENERATED column: fails because the column is inherited */
create table periodst2parent (id integer, ds date, de date, p daterange not null generated always as (daterange(ds, de)) stored);
create table periodst2 (period for p (ds, de) with (colexists = true)) inherits (periodst2parent);
ERROR:  Inheriting is not supported when a table has a PERIOD
drop table periodst2parent;
/*
 * ALTER TABLE tests
 */
alter table periodst drop period for p;
alter table periodst add period for system_time (ds, de);
ERROR:  PERIOD FOR SYSTEM_TIME is not supported
alter table periodst add period for p (ds, de);
/* Its generated column looks good */
select attname, atttypid::regtype, attnotnull, attgenerated from pg_attribute where attrelid = 'periodst'::regclass and attname = 'p';
 attname | atttypid  | attnotnull | attgenerated 
---------+-----------+------------+--------------
 p       | daterange | t          | s
(1 row)

select conname, contype from pg_constraint where conrelid = 'periodst'::regclass order by conname;
       conname       | contype 
---------------------+---------
 periodst_p_check    | c
 periodst_p_not_null | n
(2 rows)

/* Adding a second one */
create table periodst2 (id integer, ds date, de date, period for p1 (ds, de));
alter table periodst2 add period for p2 (ds, de);
drop table periodst2;
/* Can't drop its columns */
alter table periodst drop column ds;
ERROR:  cannot drop column ds of table periodst because other objects depend on it
DETAIL:  period p on table periodst depends on column ds of table periodst
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
alter table periodst drop column de;
ERROR:  cannot drop column de of table periodst because other objects depend on it
DETAIL:  period p on table periodst depends on column de of table periodst
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
/* Can't change the data types */
alter table periodst alter column ds type timestamp;
ERROR:  cannot alter type of a column used by a period
DETAIL:  period p on table periodst depends on column "ds"
alter table periodst alter column ds type timestamp;
ERROR:  cannot alter type of a column used by a period
DETAIL:  period p on table periodst depends on column "ds"
/* column/period namespace conflicts */
alter table periodst add column p integer;
ERROR:  column name "p" conflicts with a period name
alter table periodst rename column id to p;
ERROR:  column name "p" conflicts with a period name
alter table periodst add period for tableoid (ds, de);
ERROR:  period name "tableoid" conflicts with a system column name
alter table periodst add period for "........pg.dropped.4........" (ds, de);
ERROR:  period name "........pg.dropped.4........" conflicts with a column name
/* adding columns and the period at the same time */
create table periodst2 (id integer);
alter table periodst2 add column ds date, add column de date, add period for p (ds, de);
drop table periodst2;
/* Ambiguous range types raise an error */
create type mydaterange as range(subtype=date);
create table periodst2 (id int, ds date, de date, period for p (ds, de));
ERROR:  ambiguous range for type date
/* You can give an explicit range type */
create table periodst2 (id int, ds date, de date, period for p (ds, de) with (rangetype = 'mydaterange'));
drop type mydaterange;
ERROR:  cannot drop type mydaterange because other objects depend on it
DETAIL:  period p on table periodst2 depends on type mydaterange
HINT:  Use DROP ... CASCADE to drop the dependent objects too.
drop type mydaterange cascade;
NOTICE:  drop cascades to period p on table periodst2
drop table periodst2;
create table periodst2 (id int, ds date, de date, period for p (ds, de) with (rangetype = 'daterange'));
/* Range type is not found */
create table periodst3 (id int, ds date, de date, period for p (ds, de) with (rangetype = 'notarange'));
ERROR:  Range type notarange not found
/* Range type is the wrong type */
create table periodst3 (id int, ds date, de date, period for p (ds, de) with (rangetype = 'tstzrange'));
ERROR:  Range type tstzrange does not match column type date
drop table periodst2;
/* Period can't use the same colum for start and end*/
create table periodst2 (id integer, ds date, de date);
alter table periodst2 add period for p (ds, ds);
ERROR:  column "ds" can't be the start and end column for period "p"
drop table periodst2;
/* Skip creating GENERATED column: works */
create table periodst2 (id integer, ds date, de date, p daterange not null generated always as (daterange(ds, de)) stored);
alter table periodst2 add period for p (ds, de) with (colexists = true);
\d periodst2
             Table "public.periodst2"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           |          | 
 ds     | date    |           |          | 
 de     | date    |           |          | 
Periods:
    p (ds, de)
Check constraints:
    "periodst2_p_check" CHECK (ds < de)

drop table periodst2;
/* Skip creating GENERATED column: fails because the col isn't there */
create table periodst2 (id integer, ds date, de date);
alter table periodst2 add period for p (ds, de) with (colexists = true);
ERROR:  column "p" of relation "periodst2" does not exist
drop table periodst2;
/* Skip creating GENERATED column: fails because the option has an invalid value */
create table periodst2 (id integer, ds date, de date, p daterange not null generated always as (daterange(ds, de)) stored);
alter table periodst2 add period for p (ds, de) with (colexists = 'whatever');
ERROR:  colexists requires a Boolean value
drop table periodst2;
/* Skip creating GENERATED column: fails because the column is not NOT NULL */
create table periodst2 (id integer, ds date, de date, p daterange generated always as (daterange(ds, de)) stored);
alter table periodst2 add period for p (ds, de) with (colexists = true);
ERROR:  Period p uses a generated column that allows nulls
drop table periodst2;
/* Skip creating GENERATED column: fails because the column is not GENERATED */
create table periodst2 (id integer, ds date, de date, p daterange not null);
alter table periodst2 add period for p (ds, de) with (colexists = true);
ERROR:  Period p uses a non-generated column
drop table periodst2;
/* Skip creating GENERATED column: fails because the column is GENERATED but with the wrong expression */
-- TODO:
-- create table periodst2 (id integer, ds date, de date, p daterange not null generated always as (daterange(de, ds)) stored);
-- alter table periodst2 add period for p (ds, de) with (colexists = true);
/* Skip creating GENERATED column: fails because the column is the wrong type */
create table periodst2 (id integer, ds date, de date, p tsrange not null generated always as (tsrange(ds, de)) stored);
alter table periodst2 add period for p (ds, de) with (colexists = true);
ERROR:  Period p uses a generated column with the wrong type
drop table periodst2;
/* Skip creating GENERATED column: fails because the column is inherited */
create table periodst2parent (id integer, ds date, de date, p daterange not null generated always as (daterange(ds, de)) stored);
create table periodst2 () inherits (periodst2parent);
alter table periodst2 add period for p (ds, de) with (colexists = true);
ERROR:  Period p uses a generated column that is inherited
drop table periodst2;
drop table periodst2parent;
/* CREATE TABLE (LIKE ...) */
/* Periods are not copied by LIKE, so their columns aren't either */
create table periodst2 (like periodst);
\d periodst2
             Table "public.periodst2"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           |          | 
 ds     | date    |           |          | 
 de     | date    |           |          | 

drop table periodst2;
/* Can add a period referring to LIKE'd columns */
create table not_p (id integer, ds date, de date);
create table periodst2 (like not_p, period for p (ds, de));
\d periodst2
             Table "public.periodst2"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           |          | 
 ds     | date    |           |          | 
 de     | date    |           |          | 
Periods:
    p (ds, de)
Check constraints:
    "periodst2_p_check" CHECK (ds < de)

drop table periodst2;
/* Can add a period with the same name */
create table periodst2 (like periodst, period for p (ds, de));
\d periodst2
             Table "public.periodst2"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           |          | 
 ds     | date    |           |          | 
 de     | date    |           |          | 
Periods:
    p (ds, de)
Check constraints:
    "periodst2_p_check" CHECK (ds < de)

drop table periodst2;
/* Can add a period with a different name */
create table periodst2 (like periodst, period for p2 (ds, de));
\d periodst2
             Table "public.periodst2"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           |          | 
 ds     | date    |           |          | 
 de     | date    |           |          | 
Periods:
    p2 (ds, de)
Check constraints:
    "periodst2_p2_check" CHECK (ds < de)

drop table periodst2;
/* Can't add a period whose name conflicts with a LIKE'd column */
create table periodst2 (like periodst, period for id (ds, de));
ERROR:  period name "id" conflicts with a column name
/* CREATE TALBE INHERITS */
/* Can't inherit from a table with a period */
create table periodst2 (name text) inherits (periodst);
ERROR:  Inheriting from a table with a PERIOD is not supported
/* Can't inherit with a period */
create table periodst2 (d2s date, d2e date, period for p (d2s, d2e)) inherits (not_p);
ERROR:  Inheriting is not supported when a table has a PERIOD
drop table not_p;
